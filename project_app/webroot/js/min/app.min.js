function htmlentities(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}App=angular.module("App",["ngSanitize","ngAnimate"]),App.filter("nl2br",function(){return function(e){return e=htmlentities(e),e.replace(/\n/g,"<br>")}}),App.filter("parseUrl",function(){var e=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?!^=%&amp;:\/~+#-]*[\w@?!^=%&amp;\/~+#-])?/gi;return function(t,a,d){return d=d||null,angular.forEach(t.match(e),function(e){t=d?t.replace(e,'<a target="'+a+'" href='+e+' style="'+d+'">'+e+"</a>"):t.replace(e,'<a target="'+a+'" href='+e+">"+e+"</a>")}),t}}),App.controller("TimelineController",["$scope","$filter",function(e){var t=$("#projects_content").data("url");e.projects=[],e.newScheduleDate="",$.getJSON(t+"get_project_lists/",function(t){e.$apply(function(){if(e.projects=t,""!==window.location.hash){var a=window.location.hash.replace(/^#\!/,""),d=a.split("+")[0];setTimeout(function(){e.newMessage="",e.switchClient(d,!0)},200)}else e.switchIndex()})}),$(window).on("load",function(){e.$apply(function(){a(),$(document).on("click",".pagination a",function(e){e.preventDefault();var t=window.location.hash.replace(/^#\!/,""),a=t.split("+")[0];a+="+page="+$(this).text(),window.location.hash="!"+a})}),$(document).on("keydown.add_message",".message-text",function(t){13==t.keyCode&&t.shiftKey&&(t.preventDefault(),add=!1,$(".message-text").off("keydown.add_message"),$(this).hasData("id")?e.editMessage($(this).data("id")):e.addMessage())})}),e.now_date=(new Date).getTime(),e.add_new=!1,e.newMessage="",e.showMessageFrom=function(){e.add_new=!0,setTimeout(function(){e.now_date=(new Date).getTime(),$(".message-text").trigger("focus")},150)},e.hideMessageFrom=function(){e.add_new=!1},e.addMessage=function(){""==e.newMessage?alert("入力してください"):(e.add_new=!1,$.ajax({url:t+"add_message/",type:"Post",data:{data:{Message:{project_id:e.id,body:e.newMessage,user_id:e.author.id,date:e.now_date}}},success:function(t){e.newMessage="",e.$apply(function(){e.messages.push(t)})}}))},e.editMessage=function(a){""==a.body?alert("入力してください"):(e.add_new=!1,$.ajax({url:t+"add_message/"+a.id,type:"Post",data:{data:{Message:{project_id:e.id,body:a.body,user_id:e.author.id,date:e.now_date}}},success:function(t){e.$apply(function(){for(var a=0;a<e.messages.length;a++)e.messages[a].id==t.id&&(e.messages[a]=t)})}}))},e.hideEditMessageFrom=function(t){var a=e.messages.indexOf(t);e.messages[a].edit=!1},e.trigger_edit_message=function(t){var a=e.messages.indexOf(t);e.messages[a].edit=!0},e.delete_message=function(a){var d={title:"本当に削除しますか？",size:"xs",content:"このメッセージを削除します。よろしければ[ 削除 ]ボタンを押してください。",submitClass:"btn-danger delete_message",submitText:"削除",footer:!0},n=$("#modal_tmpl").tmpl(d);$("#get-modal").html(n),$(".modal").modal(),$("#get-modal .modal-body").append($("#message-"+a).clone()),$(document).on("click.delete_message",".delete_message",function(){$(".modal").modal("hide"),$.ajax({url:t+"delete_message/"+a,type:"Post",data:{data:{project_id:e.id}},success:function(t){e.$apply(function(){for(var a=0;a<e.messages.length;a++)e.messages[a].id==t.id&&e.messages.splice(a,1)})}})}),$(".modal").on("hidden.bs.modal",function(){$(document).off("click.delete_message",".delete_message")})},e.date_class=function(e){if(0==e.completed){var t=new Date;if(lastW=t.getTime()/1e3-604800,today=t.getTime()/1e3,date=new Date(e.date).getTime()/1e3,today>date){if(date>lastW)return"warning";if(lastW>date)return"danger"}return"yet"}},e.schedule_away=function(e){var t=new Date,a=t.getTime(),d=new Date(e.date).getTime();if(d>a){var n=d-a,n=Math.floor(n/864e5);return"残り"+(n+1)+"日"}var n=a-d,n=Math.floor(n/864e5);return n+"日経過"},e.schedule_complete=function(a){$.ajax({url:t+"schedule_complete/"+a.id,type:"Post",data:{data:{completed:1,project_id:e.id}},success:function(t){e.$apply(function(){var d=e.schedules.indexOf(a);e.schedules[d].completed=!0,e.schedules[d].complete_date=t.date})}})},e.schedule_uncomplete=function(a){$.ajax({url:t+"schedule_complete/"+a.id,type:"Post",data:{data:{completed:0,project_id:e.id}},success:function(){e.$apply(function(){var t=e.schedules.indexOf(a);e.schedules[t].completed=!1})}})},e.delete_schedule=function(a){var d={title:"本当に削除しますか？",size:"xs",content:"このスケジュールを削除します。よろしければ[ 削除 ]ボタンを押してください。",submitClass:"btn-danger delete_schedule",submitText:"削除",footer:!0},n=$("#modal_tmpl").tmpl(d);$("#get-modal").html(n),$(".modal").modal(),$("#get-modal .modal-body").append($("#schedule-"+a).clone()),$(document).on("click.delete_schedule",".delete_schedule",function(){$(".modal").modal("hide"),$.ajax({url:t+"delete_schedule/"+a,type:"Post",data:{data:{poject_id:e.id}},success:function(t){e.$apply(function(){for(var a=0;a<e.schedules.length;a++)e.schedules[a].id==t.id&&e.schedules.splice(a,1)})}})}),$(".modal").on("hidden.bs.modal",function(){$(document).off("click.delete_schedule",".delete_schedule")})},e.showScheduleForm=function(){e.add_schedule=!0},e.cancelSchedule=function(){e.add_schedule=!1},e.addSchedule=function(){""==e.newSchedule||""==e.newScheduleDate?alert("入力してください"):(e.add_schedule=!1,$.ajax({url:t+"add_schedule/",type:"Post",data:{data:{Schedule:{project_id:e.id,title:e.newSchedule,author_id:e.author.id,completed:0,date:e.newScheduleDate}}},success:function(t){e.newSchedule="",e.$apply(function(){e.schedules.push(t)})}}))},e.editSchedule=function(a){if(""==a.title||""==a.date)alert("入力してください");else{var d=e.schedules.indexOf(a);e.schedules[d].edit=!1,$.ajax({url:t+"add_schedule/"+a.id,type:"Post",data:{data:{Schedule:{project_id:e.id,title:a.title,author_id:e.author.id,date:a.date}}},success:function(){e.$apply(function(){})}})}},e.hideEditScheduleFrom=function(t){var a=e.schedules.indexOf(t);e.schedules[a].edit=!1},e.triggerEditSchedule=function(t){var a=e.schedules.indexOf(t);e.schedules[a].edit=!0},e.showDetailForm=function(){e.add_detail=!0},e.cancelDetail=function(){e.add_detail=!1},e.delete_detail=function(a){var d=e.details.indexOf(a),n={title:"本当に削除しますか？",size:"xs",content:"この項目を削除します。よろしければ[ 削除 ]ボタンを押してください。",submitClass:"btn-danger delete_detail",submitText:"削除",footer:!0},i=$("#modal_tmpl").tmpl(n);$("#get-modal").html(i),$(".modal").modal(),$("#get-modal .modal-body").append('<div class="panel panel-default mt20"><div class="panel-body"><dl class="dl-horizontal"><dt>'+a.key+"</dt><dd>"+a.value+"</dd></dl></div></div>"),$(document).on("click.delete_detail",".delete_detail",function(){$(".modal").modal("hide"),e.$apply(function(){e.details.splice(d,1)}),$.ajax({url:t+"add_detail/"+e.id,type:"Post",data:{data:{details:e.details}}})}),$(".modal").on("hidden.bs.modal",function(){$(document).off("click.delete_detail",".delete_detail")})},e.addDetail=function(){""==e.newDetailKey||""==e.newDetailValue?alert("入力してください"):(e.add_detail=!1,e.details.push({key:e.newDetailKey,value:e.newDetailValue}),$.ajax({url:t+"add_detail/"+e.id,type:"Post",data:{data:{details:e.details}},success:function(){e.newDetailKey="",e.newDetailValue=""}}))},e.editDetail=function(a){if(""==a.title||""==a.date)alert("入力してください");else{var d=e.details.indexOf(a);e.details[d].edit=!1,e.details[d]={key:a.key,value:a.value,order:a.order},$.ajax({url:t+"add_detail/"+e.id,type:"Post",data:{data:{details:e.details}},success:function(){e.$apply(function(){})}})}},e.hideEditDetailFrom=function(t){var a=e.details.indexOf(t);e.details[a].edit=!1},e.triggerEditDetail=function(t){var a=e.details.indexOf(t);e.details[a].edit=!0},e.showProjectFrom=function(){e.add_project=!0},e.hideProjectFrom=function(){e.add_project=!1},e.addProject=function(){""==e.newProjectName?alert("入力してください"):$.ajax({url:t+"add/",type:"Post",data:{data:{Project:{name:e.newProjectName}}},success:function(t){e.$apply(function(){e.projects.push({id:t.id,name:e.newProjectName})}),e.switchClient(t.id),e.newProjectName=""}})},e.editProject=function(a){if(""==a.name)alert("入力してください");else{var d=e.projects.indexOf(a);$.ajax({url:t+"edit/"+a.id,type:"Post",data:{data:{Project:{name:a.name}}},success:function(){e.$apply(function(){e.projects[d].name=a.name})}})}},e.switchIndex=function(){e.view=!1,window.location.hash="",e.messages=[],e.schedules=[],e.detail=[],$(".side-nav .nav li").removeClass("active"),$(".project_index").addClass("active"),setTimeout(function(){e.project.name="プロジェクト"},1e3),$.ajax({url:t+"get_information/",type:"Post",data:{},success:function(t){e.$apply(function(){i(t)})}})},e.switchClient=function(t,a){e.predate="",e.view=!0,e.id=t,e.messages=[],e.schedules=[],e.detail=[];var d=window.location.hash.replace(/^#\!/,""),d=d.split("+"),n=t;a&&void 0!=d[1]&&(n+="+"+d[1]),window.location.hash="!"+n,$(".side-nav .nav li").removeClass("active"),$(".side-nav .nav li.project-"+t).addClass("active")},window.addEventListener("popstate",function(){a()},!1),e.prev_date=function(t){var a=new Date;return a.setTime(t),a=a.getDate(),e.predate!=a?(e.predate=a,!0):!1};var a=function(){if(""==window.location.hash);else{var t=window.location.hash.replace(/^#\!/,"");setTimeout(function(){e.newMessage="",d(t)},400)}},d=function(a){var d=a.split("+"),s=d[0];d.length>1&&(s+="?");for(var l in d)l>0&&(s+=d[l]);$.getJSON(t+"get_data/"+s,function(t){e.$apply(function(){i(t)})}).error(function(){n()})},n=function(){var e=$("#alert_tmpl").tmpl({alertClass:"alert-danger",strong:"Not Found!",message:"ページが見つかりませんでした。"});$("#get_alert").html(e)},i=function(t){e.messages=t.messages?t.messages:[],e.author=t.author,e.project=t.project,e.schedules=t.schedules,e.details=t.details?t.details:[],e.paginate=t.paginate}}]);